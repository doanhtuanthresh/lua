-- main.lua
if game.GameId == 7332711118 then

    -- ===========================
    -- EARLY PATCH: LocalPlayerArrived
    -- ===========================
    -- M·ª•c ƒë√≠ch: t·∫°o event gi·∫£ TeleportService.LocalPlayerArrived
    -- v√† hook fallback ƒë·ªÉ tr√°nh l·ªói "LocalPlayerArrived is not a valid member..."
    pcall(function()
        local TeleportService = game:GetService("TeleportService")

        -- 1) T·∫°o BindableEvent n·∫øu ch∆∞a c√≥
        if not TeleportService:FindFirstChild("LocalPlayerArrived") then
            local fake = Instance.new("BindableEvent")
            fake.Name = "LocalPlayerArrived"
            fake.Parent = TeleportService
            warn("[Patch] Created TeleportService.LocalPlayerArrived (BindableEvent)")
        end

        -- 2) Fallback: c·ªë g·∫Øng hook __index c·ªßa metatable ƒë·ªÉ lu√¥n tr·∫£ v·ªÅ event gi·∫£ khi truy c·∫≠p
        local ok, mt = pcall(function() return getrawmetatable(TeleportService) end)
        if ok and mt then
            -- th·∫£ readonly, thay __index, r·ªìi ƒë·∫∑t l·∫°i readonly (n·∫øu m√¥i tr∆∞·ªùng cho ph√©p)
            pcall(function() setreadonly(mt, false) end)

            local oldIndex = mt.__index
            mt.__index = function(self, key)
                if key == "LocalPlayerArrived" then
                    -- tr·∫£ v·ªÅ event c√≥ s·∫µn ho·∫∑c t·∫°o m·ªõi
                    local existing = self:FindFirstChild("LocalPlayerArrived") or self:FindFirstChild("__fakeLocalPlayerArrived")
                    if existing then return existing end
                    local fake2 = Instance.new("BindableEvent")
                    fake2.Name = "__fakeLocalPlayerArrived"
                    fake2.Parent = self
                    return fake2
                end

                if type(oldIndex) == "function" then
                    return oldIndex(self, key)
                else
                    return rawget(self, key)
                end
            end

            pcall(function() setreadonly(mt, true) end)
            warn("[Patch] Hooked TeleportService __index for LocalPlayerArrived (fallback)")
        end
    end)

    -- ===========================
    -- Rest of your main.lua (Orion + modules)
    -- ===========================
    local OrionLib = loadstring(game:HttpGet("https://raw.githubusercontent.com/jensonhirst/Orion/main/source"))()

    -- import Farm module 
    local Farm = loadstring(game:HttpGet("https://raw.githubusercontent.com/doanhtuanthresh/lua/main/farm.lua"))()

    -- import Speed module
    local Speed = loadstring(game:HttpGet("https://raw.githubusercontent.com/doanhtuanthresh/lua/main/speedup.lua"))()

    -- import ToToSahur module
    local ToTo = loadstring(game:HttpGet("https://raw.githubusercontent.com/doanhtuanthresh/lua/main/autoToToSahur.lua"))()

    local Window = OrionLib:MakeWindow({
        Name = "NOKM",
        HidePremium = false,
        SaveConfig = true,
        ConfigFolder = "OrionTest"
    })

    local FarmTab = Window:MakeTab({
        Name = "Auto Farm",
        Icon = "",
        PremiumOnly = false
    })

    -- Dropdown ch·ªçn mob
    local MobDropdown
    local function createDropdown(options)
        MobDropdown = FarmTab:AddDropdown({
            Name = "Ch·ªçn qu√°i ƒë·ªÉ farm",
            Default = "",
            Options = options,
            Callback = function(Value)
                if Value == "<Kh√¥ng c√≥ qu√°i>" then
                    Farm.selectedMob = nil
                else
                    Farm.selectedMob = Value
                end
                print("[GUI] ƒê√£ ch·ªçn qu√°i:", tostring(Farm.selectedMob))
            end
        })
    end

    createDropdown(Farm.getMobList())

    -- Refresh mob list
    FarmTab:AddButton({
        Name = "üîÑ Refresh danh s√°ch qu√°i",
        Callback = function()
            local newList = Farm.getMobList()
            local ok = pcall(function() MobDropdown:Refresh(newList, true) end)
            if not ok then
                createDropdown(newList) -- fallback
            end
            OrionLib:MakeNotification({
                Name = "Refresh",
                Content = "ƒê√£ c·∫≠p nh·∫≠t danh s√°ch ("..#newList.." qu√°i).",
                Time = 3
            })
        end
    })

    -- Toggle AutoFarm
    FarmTab:AddToggle({
        Name = "Auto Farm",
        Default = false,
        Callback = function(Value)
            Farm.autofarm = Value
            if Value then Farm.start() end
        end
    })

    -- Toggle Speed
    FarmTab:AddToggle({
        Name = "‚ö° TƒÉng t·ªëc",
        Default = false,
        Callback = function(Value)
            if Value then
                Speed.set(150) -- ch·ªânh s·ªë tu·ª≥ th√≠ch
            else
                Speed.reset()
            end
        end
    })

    -- Tab Auto To To Sahur
    local ToToTab = Window:MakeTab({
        Name = "Auto To To Sahur",
        Icon = "",
        PremiumOnly = false
    })

    ToToTab:AddToggle({
        Name = "Auto To To Sahur (WorldBoss)",
        Default = false,
        Callback = function(Value)
            ToTo.auto = Value
            if Value then
                ToTo.start()
                OrionLib:MakeNotification({
                    Name = "Auto To To Sahur",
                    Content = "ƒêang sƒÉn To To Sahur...",
                    Time = 3
                })
            else
                OrionLib:MakeNotification({
                    Name = "Auto To To Sahur",
                    Content = "ƒê√£ t·∫Øt.",
                    Time = 3
                })
            end
        end
    })

    OrionLib:Init()
end
